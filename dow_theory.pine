//@version=5
indicator("Dow Theory Multi-Timeframe Trend", overlay=true, max_labels_count=500, max_lines_count=500)

// Pivot length for Dow Theory swing detection (use larger length for major pivots)
pivotLen = input.int(8, "Pivot Length (Major)", minval=1)
useAtrFilter = input.bool(true, "Filter Small Swings")
atrLen = input.int(14, "ATR Length", minval=1)
minSwingAtr = input.float(1.0, "Min Swing (ATR)", minval=0.0, step=0.1)
showPivotLines = input.bool(true, "Draw Horizontal Lines at Pivots")
pivotHighColor = input.color(color.new(color.green, 0), "Pivot High Line Color")
pivotLowColor = input.color(color.new(color.red, 0), "Pivot Low Line Color")
maxPivotLines = input.int(8, "Max Pivot Lines", minval=1, maxval=200)
pivotLineWidth = input.int(1, "Pivot Line Width", minval=1, maxval=5)
pivotLineStyle = input.string("Solid", "Pivot Line Style", options=["Solid", "Dashed", "Dotted"])
showEntryLines = input.bool(true, "Draw Entry Lines (Fib 0.786/0.618)")
entryUpColor = input.color(color.new(color.green, 0), "Entry Line Color (Up)")
entryDownColor = input.color(color.new(color.red, 0), "Entry Line Color (Down)")
entryLineWidth = input.int(1, "Entry Line Width", minval=1, maxval=5)
entryLineStyle = input.string("Dashed", "Entry Line Style", options=["Solid", "Dashed", "Dotted"])
showSwingPoints = input.bool(true, "Show Swing Start/End Points")
swingUpColor = input.color(color.new(color.green, 0), "Swing Point Color (Up)")
swingDownColor = input.color(color.new(color.red, 0), "Swing Point Color (Down)")
entryLineStyleResolved = entryLineStyle == "Dashed" ? line.style_dashed : entryLineStyle == "Dotted" ? line.style_dotted : line.style_solid
var line entryUp786 = na
var line entryUp618 = na
var line entryDown786 = na
var line entryDown618 = na

// Timeframes to evaluate
tf1 = input.timeframe("5", "TF1")
tf2 = input.timeframe("15", "TF2")
tf3 = input.timeframe("60", "TF3")
tf4 = input.timeframe("240", "TF4")
tf5 = input.timeframe("D", "TF5")
tf6 = input.timeframe("W", "TF6")

// Determine entry-line calculation timeframe: one step above the chart timeframe within the TF list
entryCalcTf = timeframe.period == tf1 ? tf2 : timeframe.period == tf2 ? tf3 : timeframe.period == tf3 ? tf4 : timeframe.period == tf4 ? tf5 : timeframe.period == tf5 ? tf6 : tf6

// Dow Theory trend calculation: +1 up, -1 down, 0 neutral
calcTrend() =>
    var float lastHigh = na
    var float prevHigh = na
    var float lastLow = na
    var float prevLow = na

    ph = ta.pivothigh(high, pivotLen, pivotLen)
    pl = ta.pivotlow(low, pivotLen, pivotLen)
    atr = ta.atr(atrLen)

    acceptHigh = not na(ph) and (not useAtrFilter or na(lastLow) or ph - lastLow >= minSwingAtr * atr)
    acceptLow = not na(pl) and (not useAtrFilter or na(lastHigh) or lastHigh - pl >= minSwingAtr * atr)

    if acceptHigh
        prevHigh := lastHigh
        lastHigh := ph
    if acceptLow
        prevLow := lastLow
        lastLow := pl

    up = not na(lastHigh) and not na(prevHigh) and not na(lastLow) and not na(prevLow) and lastHigh > prevHigh and lastLow > prevLow
    down = not na(lastHigh) and not na(prevHigh) and not na(lastLow) and not na(prevLow) and lastHigh < prevHigh and lastLow < prevLow
    up ? 1 : down ? -1 : 0

trendLabel(tr) =>
    tr == 1 ? "Up" : tr == -1 ? "Down" : "Side"

trendColor(tr) =>
    tr == 1 ? color.new(color.green, 0) : tr == -1 ? color.new(color.red, 0) : color.new(color.gray, 0)

trend_tf1 = request.security(syminfo.tickerid, tf1, calcTrend())
trend_tf2 = request.security(syminfo.tickerid, tf2, calcTrend())
trend_tf3 = request.security(syminfo.tickerid, tf3, calcTrend())
trend_tf4 = request.security(syminfo.tickerid, tf4, calcTrend())
trend_tf5 = request.security(syminfo.tickerid, tf5, calcTrend())
trend_tf6 = request.security(syminfo.tickerid, tf6, calcTrend())

// Entry line calculation on higher timeframe (two steps above)
calcEntryLine(selector) =>
    var float lastHigh = na
    var float prevHigh = na
    var float lastLow = na
    var float prevLow = na
    var float swingUpLowLocal = na
    var float swingUpHighLocal = na
    var float swingDownHighLocal = na
    var float swingDownLowLocal = na
    var int lastPivotDirLocal = 0

    phLocal = ta.pivothigh(high, pivotLen, pivotLen)
    plLocal = ta.pivotlow(low, pivotLen, pivotLen)
    atrLocal = ta.atr(atrLen)

    acceptHighLocal = not na(phLocal) and (not useAtrFilter or na(lastLow) or phLocal - lastLow >= minSwingAtr * atrLocal)
    acceptLowLocal = not na(plLocal) and (not useAtrFilter or na(lastHigh) or lastHigh - plLocal >= minSwingAtr * atrLocal)

    if acceptHighLocal
        prevHigh := lastHigh
        lastHigh := phLocal
        if lastPivotDirLocal == -1 and not na(lastLow)
            swingUpLowLocal := lastLow
            swingUpHighLocal := phLocal
        lastPivotDirLocal := 1

    if acceptLowLocal
        prevLow := lastLow
        lastLow := plLocal
        if lastPivotDirLocal == 1 and not na(lastHigh)
            swingDownHighLocal := lastHigh
            swingDownLowLocal := plLocal
        lastPivotDirLocal := -1

    trendUpLocal = not na(lastHigh) and not na(prevHigh) and not na(lastLow) and not na(prevLow) and lastHigh > prevHigh and lastLow > prevLow
    trendDownLocal = not na(lastHigh) and not na(prevHigh) and not na(lastLow) and not na(prevLow) and lastHigh < prevHigh and lastLow < prevLow

    fibUpRangeLocal = not na(swingUpHighLocal) and not na(swingUpLowLocal) ? (swingUpHighLocal - swingUpLowLocal) : na
    fibDownRangeLocal = not na(swingDownHighLocal) and not na(swingDownLowLocal) ? (swingDownHighLocal - swingDownLowLocal) : na
    fibUp786Local = not na(fibUpRangeLocal) ? (swingUpLowLocal + fibUpRangeLocal * 0.786) : na
    fibUp618Local = not na(fibUpRangeLocal) ? (swingUpLowLocal + fibUpRangeLocal * 0.618) : na
    fibDown786Local = not na(fibDownRangeLocal) ? (swingDownHighLocal - fibDownRangeLocal * 0.786) : na
    fibDown618Local = not na(fibDownRangeLocal) ? (swingDownHighLocal - fibDownRangeLocal * 0.618) : na

    selector == 0 ? fibUp786Local :
     selector == 1 ? fibUp618Local :
     selector == 2 ? fibDown786Local :
     selector == 3 ? fibDown618Local :
     selector == 4 ? (trendUpLocal ? 1.0 : 0.0) :
     selector == 5 ? (trendDownLocal ? 1.0 : 0.0) :
     na

fibUp786HTF = request.security(syminfo.tickerid, entryCalcTf, calcEntryLine(0))
fibUp618HTF = request.security(syminfo.tickerid, entryCalcTf, calcEntryLine(1))
fibDown786HTF = request.security(syminfo.tickerid, entryCalcTf, calcEntryLine(2))
fibDown618HTF = request.security(syminfo.tickerid, entryCalcTf, calcEntryLine(3))
trendUpHTF = request.security(syminfo.tickerid, entryCalcTf, calcEntryLine(4)) == 1.0
trendDownHTF = request.security(syminfo.tickerid, entryCalcTf, calcEntryLine(5)) == 1.0

// Horizontal lines from pivot prices on the chart timeframe
ph = ta.pivothigh(high, pivotLen, pivotLen)
pl = ta.pivotlow(low, pivotLen, pivotLen)
atr = ta.atr(atrLen)
lineStyle = pivotLineStyle == "Dashed" ? line.style_dashed : pivotLineStyle == "Dotted" ? line.style_dotted : line.style_solid
var line[] pivotHighLines = array.new_line()
var line[] pivotLowLines = array.new_line()
var float lastMajorHigh = na
var float lastMajorLow = na
var float prevMajorHigh = na
var float prevMajorLow = na
var int lastMajorHighIndex = na
var int lastMajorLowIndex = na
var int lastPivotDir = 0
var float swingUpLow = na
var float swingUpHigh = na
var float swingDownHigh = na
var float swingDownLow = na
var int swingUpLowIndex = na
var int swingUpHighIndex = na
var int swingDownHighIndex = na
var int swingDownLowIndex = na
var label swingUpLowLabel = na
var label swingUpHighLabel = na
var label swingDownHighLabel = na
var label swingDownLowLabel = na
addPivotLine(line[] store, float price, color lineColor) =>
    if array.size(store) >= maxPivotLines
        old = array.shift(store)
        if not na(old)
            line.delete(old)
    nl = line.new(bar_index - pivotLen, price, bar_index, price, extend=extend.right, color=lineColor, width=pivotLineWidth, style=lineStyle)
    array.push(store, nl)

acceptHigh = not na(ph) and (not useAtrFilter or na(lastMajorLow) or ph - lastMajorLow >= minSwingAtr * atr)
acceptLow = not na(pl) and (not useAtrFilter or na(lastMajorHigh) or lastMajorHigh - pl >= minSwingAtr * atr)

if acceptHigh
    prevMajorHigh := lastMajorHigh
    lastMajorHigh := ph
    lastMajorHighIndex := bar_index - pivotLen
    if lastPivotDir == -1 and not na(lastMajorLow)
        swingUpLow := lastMajorLow
        swingUpHigh := ph
        swingUpLowIndex := lastMajorLowIndex
        swingUpHighIndex := lastMajorHighIndex
        if showSwingPoints
            if not na(swingUpLowLabel)
                label.delete(swingUpLowLabel)
            if not na(swingUpHighLabel)
                label.delete(swingUpHighLabel)
            swingUpLowLabel := label.new(swingUpLowIndex, swingUpLow, "Up Low", style=label.style_label_up, textcolor=color.white, color=swingUpColor, size=size.tiny)
            swingUpHighLabel := label.new(swingUpHighIndex, swingUpHigh, "Up High", style=label.style_label_down, textcolor=color.white, color=swingUpColor, size=size.tiny)
    lastPivotDir := 1
    if showPivotLines
        addPivotLine(pivotHighLines, ph, pivotHighColor)
if acceptLow
    prevMajorLow := lastMajorLow
    lastMajorLow := pl
    lastMajorLowIndex := bar_index - pivotLen
    if lastPivotDir == 1 and not na(lastMajorHigh)
        swingDownHigh := lastMajorHigh
        swingDownLow := pl
        swingDownHighIndex := lastMajorHighIndex
        swingDownLowIndex := lastMajorLowIndex
        if showSwingPoints
            if not na(swingDownHighLabel)
                label.delete(swingDownHighLabel)
            if not na(swingDownLowLabel)
                label.delete(swingDownLowLabel)
            swingDownHighLabel := label.new(swingDownHighIndex, swingDownHigh, "Down High", style=label.style_label_down, textcolor=color.white, color=swingDownColor, size=size.tiny)
            swingDownLowLabel := label.new(swingDownLowIndex, swingDownLow, "Down Low", style=label.style_label_up, textcolor=color.white, color=swingDownColor, size=size.tiny)
    lastPivotDir := -1
    if showPivotLines
        addPivotLine(pivotLowLines, pl, pivotLowColor)

// Entry lines at Fib 0.786 / 0.618 based on current major trend
trendUp = not na(lastMajorHigh) and not na(prevMajorHigh) and not na(lastMajorLow) and not na(prevMajorLow) and lastMajorHigh > prevMajorHigh and lastMajorLow > prevMajorLow
trendDown = not na(lastMajorHigh) and not na(prevMajorHigh) and not na(lastMajorLow) and not na(prevMajorLow) and lastMajorHigh < prevMajorHigh and lastMajorLow < prevMajorLow

fibUpRange = not na(swingUpHigh) and not na(swingUpLow) ? (swingUpHigh - swingUpLow) : na
fibDownRange = not na(swingDownHigh) and not na(swingDownLow) ? (swingDownHigh - swingDownLow) : na
fibUp786 = not na(fibUpRange) ? (swingUpLow + fibUpRange * 0.786) : na
fibUp618 = not na(fibUpRange) ? (swingUpLow + fibUpRange * 0.618) : na
fibDown786 = not na(fibDownRange) ? (swingDownHigh - fibDownRange * 0.786) : na
fibDown618 = not na(fibDownRange) ? (swingDownHigh - fibDownRange * 0.618) : na

if showEntryLines and ((trendUpHTF and not na(fibUp786HTF)) or (trendDownHTF and not na(fibDown786HTF)))
    if not na(entryUp786)
        line.delete(entryUp786)
        entryUp786 := na
    if not na(entryUp618)
        line.delete(entryUp618)
        entryUp618 := na
    if not na(entryDown786)
        line.delete(entryDown786)
        entryDown786 := na
    if not na(entryDown618)
        line.delete(entryDown618)
        entryDown618 := na
    if trendUpHTF
        entryUp786 := line.new(bar_index - pivotLen, fibUp786HTF, bar_index, fibUp786HTF, extend=extend.right, color=entryUpColor, width=entryLineWidth, style=entryLineStyleResolved)
        entryUp618 := line.new(bar_index - pivotLen, fibUp618HTF, bar_index, fibUp618HTF, extend=extend.right, color=entryUpColor, width=entryLineWidth, style=entryLineStyleResolved)
    if trendDownHTF
        entryDown786 := line.new(bar_index - pivotLen, fibDown786HTF, bar_index, fibDown786HTF, extend=extend.right, color=entryDownColor, width=entryLineWidth, style=entryLineStyleResolved)
        entryDown618 := line.new(bar_index - pivotLen, fibDown618HTF, bar_index, fibDown618HTF, extend=extend.right, color=entryDownColor, width=entryLineWidth, style=entryLineStyleResolved)
else if not showEntryLines
    if not na(entryUp786)
        line.delete(entryUp786)
        entryUp786 := na
    if not na(entryUp618)
        line.delete(entryUp618)
        entryUp618 := na
    if not na(entryDown786)
        line.delete(entryDown786)
        entryDown786 := na
    if not na(entryDown618)
        line.delete(entryDown618)
        entryDown618 := na

// Table UI
var table t = table.new(position.top_right, 2, 7, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(t, 0, 0, "TF", text_color=color.white, text_halign=text.align_center)
    table.cell(t, 1, 0, "Trend", text_color=color.white, text_halign=text.align_center)

    table.cell(t, 0, 1, tf1, text_color=color.white)
    table.cell(t, 1, 1, trendLabel(trend_tf1), text_color=color.white, bgcolor=trendColor(trend_tf1))

    table.cell(t, 0, 2, tf2, text_color=color.white)
    table.cell(t, 1, 2, trendLabel(trend_tf2), text_color=color.white, bgcolor=trendColor(trend_tf2))

    table.cell(t, 0, 3, tf3, text_color=color.white)
    table.cell(t, 1, 3, trendLabel(trend_tf3), text_color=color.white, bgcolor=trendColor(trend_tf3))

    table.cell(t, 0, 4, tf4, text_color=color.white)
    table.cell(t, 1, 4, trendLabel(trend_tf4), text_color=color.white, bgcolor=trendColor(trend_tf4))

    table.cell(t, 0, 5, tf5, text_color=color.white)
    table.cell(t, 1, 5, trendLabel(trend_tf5), text_color=color.white, bgcolor=trendColor(trend_tf5))

    table.cell(t, 0, 6, tf6, text_color=color.white)
    table.cell(t, 1, 6, trendLabel(trend_tf6), text_color=color.white, bgcolor=trendColor(trend_tf6))
