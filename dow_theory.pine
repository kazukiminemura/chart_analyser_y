//@version=5
indicator("Dow Theory Multi-Timeframe Trend", overlay=true, max_labels_count=500, max_lines_count=500)

// Pivot length for Dow Theory swing detection (use larger length for major pivots)
pivotLen = input.int(8, "Pivot Length (Major)", minval=1)
useAtrFilter = input.bool(true, "Filter Small Swings")
atrLen = input.int(14, "ATR Length", minval=1)
minSwingAtr = input.float(1.0, "Min Swing (ATR)", minval=0.0, step=0.1)
showPivotLines = input.bool(true, "Draw Horizontal Lines at Pivots")
pivotHighColor = input.color(color.new(color.green, 0), "Pivot High Line Color")
pivotLowColor = input.color(color.new(color.red, 0), "Pivot Low Line Color")
maxPivotLines = input.int(8, "Max Pivot Lines", minval=1, maxval=200)
pivotLineWidth = input.int(1, "Pivot Line Width", minval=1, maxval=5)
pivotLineStyle = input.string("Solid", "Pivot Line Style", options=["Solid", "Dashed", "Dotted"])
showSwingPoints = input.bool(true, "Show Swing Start/End Points")
swingUpColor = input.color(color.new(color.green, 0), "Swing Point Color (Up)")
swingDownColor = input.color(color.new(color.red, 0), "Swing Point Color (Down)")
showPaMarks = input.bool(true, "Show Yosuga PA Marks (Provisional)")
paLongUpperWick = input.bool(true, "PA: Long Upper Wick")
paWickBodyRatio = input.float(2.0, "Upper Wick >= Body x", minval=0.1, step=0.1)
paLongLowerWick = input.bool(true, "PA: Long Lower Wick")
paLowerWickBodyRatio = input.float(2.0, "Lower Wick >= Body x", minval=0.1, step=0.1)
paOppWickBodyMax = input.float(0.3, "Opposite Wick <= Body x", minval=0.0, step=0.1)
paRequireLine = input.bool(true, "PA: Require Clear Line (Pivot High/Low)")
paLineAtrTolerance = input.float(0.3, "PA: Line Proximity (ATR)", minval=0.0, step=0.1)
paRequireFlow = input.bool(true, "PA: Require Prior Flow")
paRequireFollow = input.bool(true, "PA: Require Next-Bar Follow-Through")
showEntryFibLines = input.bool(true, "Show Entry Candidate Lines (Fib 0.786)")
entryLongColor = input.color(color.new(color.green, 0), "Entry Line Color (Long)")
entryShortColor = input.color(color.new(color.red, 0), "Entry Line Color (Short)")
entryLineWidth = input.int(1, "Entry Line Width", minval=1, maxval=5)
entryLineStyle = input.string("Dashed", "Entry Line Style", options=["Solid", "Dashed", "Dotted"])
showPositionLines = input.bool(true, "Show Position Lines")
positionLongColor = input.color(color.new(color.green, 0), "Position Line Color (Long)")
positionShortColor = input.color(color.new(color.red, 0), "Position Line Color (Short)")
positionLineWidth = input.int(2, "Position Line Width", minval=1, maxval=5)
positionLineStyle = input.string("Solid", "Position Line Style", options=["Solid", "Dashed", "Dotted"])
showTakeProfitLines = input.bool(true, "Show Take Profit Lines")
tpLongColor = input.color(color.new(color.green, 0), "TP Line Color (Long)")
tpShortColor = input.color(color.new(color.red, 0), "TP Line Color (Short)")
tpLineWidth = input.int(1, "TP Line Width", minval=1, maxval=5)
tpLineStyle = input.string("Dotted", "TP Line Style", options=["Solid", "Dashed", "Dotted"])

// Timeframes to evaluate
tf1 = input.timeframe("5", "TF1")
tf2 = input.timeframe("15", "TF2")
tf3 = input.timeframe("60", "TF3")
tf4 = input.timeframe("240", "TF4")
tf5 = input.timeframe("D", "TF5")
tf6 = input.timeframe("W", "TF6")
lockTf2PerDay = input.bool(true, "Lock TF2 Trend Per Day (on TF2 chart)")

// Dow Theory trend calculation: +1 up, -1 down, 0 neutral
calcTrend() =>
    var float lastHigh = na
    var float prevHigh = na
    var float lastLow = na
    var float prevLow = na

    ph = ta.pivothigh(high, pivotLen, pivotLen)
    pl = ta.pivotlow(low, pivotLen, pivotLen)
    atr = ta.atr(atrLen)

    acceptHigh = not na(ph) and (not useAtrFilter or na(lastLow) or ph - lastLow >= minSwingAtr * atr)
    acceptLow = not na(pl) and (not useAtrFilter or na(lastHigh) or lastHigh - pl >= minSwingAtr * atr)

    if acceptHigh
        prevHigh := lastHigh
        lastHigh := ph
    if acceptLow
        prevLow := lastLow
        lastLow := pl

    up = not na(lastHigh) and not na(prevHigh) and not na(lastLow) and not na(prevLow) and lastHigh > prevHigh and lastLow > prevLow
    down = not na(lastHigh) and not na(prevHigh) and not na(lastLow) and not na(prevLow) and lastHigh < prevHigh and lastLow < prevLow
    up ? 1 : down ? -1 : 0

trendLabel(tr) =>
    tr == 1 ? "Up" : tr == -1 ? "Down" : "Side"

trendColor(tr) =>
    tr == 1 ? color.new(color.green, 0) : tr == -1 ? color.new(color.red, 0) : color.new(color.gray, 0)

trend_tf1 = request.security(syminfo.tickerid, tf1, calcTrend())
trend_tf2 = request.security(syminfo.tickerid, tf2, calcTrend())
trend_tf3 = request.security(syminfo.tickerid, tf3, calcTrend())
trend_tf4 = request.security(syminfo.tickerid, tf4, calcTrend())
trend_tf5 = request.security(syminfo.tickerid, tf5, calcTrend())
trend_tf6 = request.security(syminfo.tickerid, tf6, calcTrend())

dayStamp = time("D")
lockTf2Now = lockTf2PerDay and timeframe.isintraday and timeframe.period == tf2
var int lastLockDay = na
var float trend_tf2_locked = na
if lockTf2Now
    if na(lastLockDay) or dayStamp != lastLockDay
        lastLockDay := dayStamp
        trend_tf2_locked := trend_tf2
else
    trend_tf2_locked := trend_tf2
trend_tf2_display = lockTf2Now ? trend_tf2_locked : trend_tf2

// Horizontal lines from pivot prices on the chart timeframe
ph = ta.pivothigh(high, pivotLen, pivotLen)
pl = ta.pivotlow(low, pivotLen, pivotLen)
atr = ta.atr(atrLen)
lineStyle = pivotLineStyle == "Dashed" ? line.style_dashed : pivotLineStyle == "Dotted" ? line.style_dotted : line.style_solid
var line[] pivotHighLines = array.new_line()
var line[] pivotLowLines = array.new_line()
var float lastMajorHigh = na
var float lastMajorLow = na
var float prevMajorHigh = na
var float prevMajorLow = na
var int lastMajorHighIndex = na
var int lastMajorLowIndex = na
var int lastPivotDir = 0
var float swingUpLow = na
var float swingUpHigh = na
var float swingDownHigh = na
var float swingDownLow = na
var int swingUpLowIndex = na
var int swingUpHighIndex = na
var int swingDownHighIndex = na
var int swingDownLowIndex = na
var label swingUpLowLabel = na
var label swingUpHighLabel = na
var label swingDownHighLabel = na
var label swingDownLowLabel = na
addPivotLine(line[] store, float price, color lineColor) =>
    if array.size(store) >= maxPivotLines
        old = array.shift(store)
        if not na(old)
            line.delete(old)
    nl = line.new(bar_index - pivotLen, price, bar_index, price, extend=extend.right, color=lineColor, width=pivotLineWidth, style=lineStyle)
    array.push(store, nl)

acceptHigh = not na(ph) and (not useAtrFilter or na(lastMajorLow) or ph - lastMajorLow >= minSwingAtr * atr)
acceptLow = not na(pl) and (not useAtrFilter or na(lastMajorHigh) or lastMajorHigh - pl >= minSwingAtr * atr)

if acceptHigh
    prevMajorHigh := lastMajorHigh
    lastMajorHigh := ph
    lastMajorHighIndex := bar_index - pivotLen
    if lastPivotDir == -1 and not na(lastMajorLow)
        swingUpLow := lastMajorLow
        swingUpHigh := ph
        swingUpLowIndex := lastMajorLowIndex
        swingUpHighIndex := lastMajorHighIndex
        if showSwingPoints
            if not na(swingUpLowLabel)
                label.delete(swingUpLowLabel)
            if not na(swingUpHighLabel)
                label.delete(swingUpHighLabel)
            swingUpLowLabel := label.new(swingUpLowIndex, swingUpLow, "Up Low", style=label.style_label_up, textcolor=color.white, color=swingUpColor, size=size.tiny)
            swingUpHighLabel := label.new(swingUpHighIndex, swingUpHigh, "Up High", style=label.style_label_down, textcolor=color.white, color=swingUpColor, size=size.tiny)
    lastPivotDir := 1
    if showPivotLines
        addPivotLine(pivotHighLines, ph, pivotHighColor)
if acceptLow
    prevMajorLow := lastMajorLow
    lastMajorLow := pl
    lastMajorLowIndex := bar_index - pivotLen
    if lastPivotDir == 1 and not na(lastMajorHigh)
        swingDownHigh := lastMajorHigh
        swingDownLow := pl
        swingDownHighIndex := lastMajorHighIndex
        swingDownLowIndex := lastMajorLowIndex
        if showSwingPoints
            if not na(swingDownHighLabel)
                label.delete(swingDownHighLabel)
            if not na(swingDownLowLabel)
                label.delete(swingDownLowLabel)
            swingDownHighLabel := label.new(swingDownHighIndex, swingDownHigh, "Down High", style=label.style_label_down, textcolor=color.white, color=swingDownColor, size=size.tiny)
            swingDownLowLabel := label.new(swingDownLowIndex, swingDownLow, "Down Low", style=label.style_label_up, textcolor=color.white, color=swingDownColor, size=size.tiny)
    lastPivotDir := -1
    if showPivotLines
        addPivotLine(pivotLowLines, pl, pivotLowColor)

// Yosuga-style PA (provisional) on signal-confirm bars
trendUp = not na(lastMajorHigh) and not na(prevMajorHigh) and not na(lastMajorLow) and not na(prevMajorLow) and lastMajorHigh > prevMajorHigh and lastMajorLow > prevMajorLow
trendDown = not na(lastMajorHigh) and not na(prevMajorHigh) and not na(lastMajorLow) and not na(prevMajorLow) and lastMajorHigh < prevMajorHigh and lastMajorLow < prevMajorLow

entryLineStyleResolved = entryLineStyle == "Dashed" ? line.style_dashed : entryLineStyle == "Dotted" ? line.style_dotted : line.style_solid
positionLineStyleResolved = positionLineStyle == "Dashed" ? line.style_dashed : positionLineStyle == "Dotted" ? line.style_dotted : line.style_solid
tpLineStyleResolved = tpLineStyle == "Dashed" ? line.style_dashed : tpLineStyle == "Dotted" ? line.style_dotted : line.style_solid

fibUpRange = not na(swingUpHigh) and not na(swingUpLow) ? (swingUpHigh - swingUpLow) : na
fibDownRange = not na(swingDownHigh) and not na(swingDownLow) ? (swingDownHigh - swingDownLow) : na
fibUp786 = not na(fibUpRange) ? (swingUpHigh - fibUpRange * 0.786) : na
fibDown786 = not na(fibDownRange) ? (swingDownLow + fibDownRange * 0.786) : na

var line entryLongLine = na
var line entryShortLine = na
if barstate.islast and showEntryFibLines
    if not na(entryLongLine)
        line.delete(entryLongLine)
    if not na(entryShortLine)
        line.delete(entryShortLine)
    if (trendUp or (not trendUp and not trendDown)) and not na(fibUp786)
        entryLongLine := line.new(bar_index - 1, fibUp786, bar_index, fibUp786, extend=extend.right, color=entryLongColor, width=entryLineWidth, style=entryLineStyleResolved)
    if (trendDown or (not trendUp and not trendDown)) and not na(fibDown786)
        entryShortLine := line.new(bar_index - 1, fibDown786, bar_index, fibDown786, extend=extend.right, color=entryShortColor, width=entryLineWidth, style=entryLineStyleResolved)

bodyPrev = math.abs(close[1] - open[1])
upperWickPrev = high[1] - math.max(open[1], close[1])
lowerWickPrev = math.min(open[1], close[1]) - low[1]
longUpperWickPrev = paLongUpperWick and bodyPrev > 0 and upperWickPrev >= bodyPrev * paWickBodyRatio
longLowerWickPrev = paLongLowerWick and bodyPrev > 0 and lowerWickPrev >= bodyPrev * paLowerWickBodyRatio
smallLowerWickPrev = bodyPrev > 0 and lowerWickPrev <= bodyPrev * paOppWickBodyMax
smallUpperWickPrev = bodyPrev > 0 and upperWickPrev <= bodyPrev * paOppWickBodyMax

nearHighLevel = not paRequireLine or ((not na(lastMajorHigh) and math.abs(high[1] - lastMajorHigh) <= atr * paLineAtrTolerance) or (not na(prevMajorHigh) and math.abs(high[1] - prevMajorHigh) <= atr * paLineAtrTolerance) or (not na(swingUpHigh) and math.abs(high[1] - swingUpHigh) <= atr * paLineAtrTolerance))
nearLowLevel = not paRequireLine or ((not na(lastMajorLow) and math.abs(low[1] - lastMajorLow) <= atr * paLineAtrTolerance) or (not na(prevMajorLow) and math.abs(low[1] - prevMajorLow) <= atr * paLineAtrTolerance) or (not na(swingDownLow) and math.abs(low[1] - swingDownLow) <= atr * paLineAtrTolerance))

flowOkDown = not paRequireFlow or (trendUp or lastPivotDir == 1)
flowOkUp = not paRequireFlow or (trendDown or lastPivotDir == -1)

followDown = not paRequireFollow or (close < close[1] and close < open)
followUp = not paRequireFollow or (close > close[1] and close > open)

paDown = showPaMarks and longUpperWickPrev and smallLowerWickPrev and nearHighLevel and flowOkDown and followDown
paUp = showPaMarks and longLowerWickPrev and smallUpperWickPrev and nearLowLevel and flowOkUp and followUp
plotshape(paDown, title="Yosuga PA Mark Down", style=shape.labeldown, location=location.abovebar,
  color=color.new(color.red, 0), text="PA", textcolor=color.white, size=size.tiny)
plotshape(paUp, title="Yosuga PA Mark Up", style=shape.labelup, location=location.belowbar,
  color=color.new(color.green, 0), text="PA", textcolor=color.white, size=size.tiny)

var line positionLongLine = na
var line positionShortLine = na
var line tpLongLine = na
var line tpShortLine = na

if barstate.islast and showPositionLines
    if not na(positionLongLine)
        line.delete(positionLongLine)
    if not na(positionShortLine)
        line.delete(positionShortLine)

if barstate.islast and showTakeProfitLines
    if not na(tpLongLine)
        line.delete(tpLongLine)
    if not na(tpShortLine)
        line.delete(tpShortLine)

if paUp and showPositionLines and not na(fibUp786)
    if not na(positionLongLine)
        line.delete(positionLongLine)
    positionLongLine := line.new(bar_index, fibUp786, bar_index + 1, fibUp786, extend=extend.right, color=positionLongColor, width=positionLineWidth, style=positionLineStyleResolved)

if paDown and showPositionLines and not na(fibDown786)
    if not na(positionShortLine)
        line.delete(positionShortLine)
    positionShortLine := line.new(bar_index, fibDown786, bar_index + 1, fibDown786, extend=extend.right, color=positionShortColor, width=positionLineWidth, style=positionLineStyleResolved)

if paUp and showTakeProfitLines and not na(swingUpHigh)
    if not na(tpLongLine)
        line.delete(tpLongLine)
    tpLongLine := line.new(bar_index, swingUpHigh, bar_index + 1, swingUpHigh, extend=extend.right, color=tpLongColor, width=tpLineWidth, style=tpLineStyleResolved)

if paDown and showTakeProfitLines and not na(swingDownLow)
    if not na(tpShortLine)
        line.delete(tpShortLine)
    tpShortLine := line.new(bar_index, swingDownLow, bar_index + 1, swingDownLow, extend=extend.right, color=tpShortColor, width=tpLineWidth, style=tpLineStyleResolved)

// Table UI
var table t = table.new(position.top_right, 2, 7, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(t, 0, 0, "TF", text_color=color.white, text_halign=text.align_center)
    table.cell(t, 1, 0, "Trend", text_color=color.white, text_halign=text.align_center)

    table.cell(t, 0, 1, tf1, text_color=color.white)
    table.cell(t, 1, 1, trendLabel(trend_tf1), text_color=color.white, bgcolor=trendColor(trend_tf1))

    table.cell(t, 0, 2, tf2, text_color=color.white)
    table.cell(t, 1, 2, trendLabel(trend_tf2_display), text_color=color.white, bgcolor=trendColor(trend_tf2_display))

    table.cell(t, 0, 3, tf3, text_color=color.white)
    table.cell(t, 1, 3, trendLabel(trend_tf3), text_color=color.white, bgcolor=trendColor(trend_tf3))

    table.cell(t, 0, 4, tf4, text_color=color.white)
    table.cell(t, 1, 4, trendLabel(trend_tf4), text_color=color.white, bgcolor=trendColor(trend_tf4))

    table.cell(t, 0, 5, tf5, text_color=color.white)
    table.cell(t, 1, 5, trendLabel(trend_tf5), text_color=color.white, bgcolor=trendColor(trend_tf5))

    table.cell(t, 0, 6, tf6, text_color=color.white)
    table.cell(t, 1, 6, trendLabel(trend_tf6), text_color=color.white, bgcolor=trendColor(trend_tf6))
