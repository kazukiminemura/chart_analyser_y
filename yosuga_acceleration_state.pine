//@version=5
indicator("Yosuga Acceleration State", overlay=true, max_lines_count=200, max_labels_count=200)

// === Inputs ===
thresholdPercent   = input.float(5.0, "Reversal Threshold (%)", minval=0.1, step=0.1)
extendLinesRight   = input.bool(true, "Extend Daily Lines to the Right")
lineLengthBars     = input.int(50, "Daily Line Length (bars when not extended)", minval=1, maxval=500)
maxStoredObjects   = input.int(40, "Maximum Stored Pivots", minval=1, maxval=100)
showPivotLabels    = input.bool(true, "Show Pivot Labels")
labelColorPeak     = input.color(color.new(color.red, 0), "Peak Label Color")
labelColorTrough   = input.color(color.new(color.green, 0), "Trough Label Color")
lineColorDailyHigh = input.color(color.new(color.orange, 0), "Daily High Line Color")
lineColorDailyLow  = input.color(color.new(color.teal, 0), "Daily Low Line Color")
lineStyleDailyText = input.string("Solid", "Daily Line Style", options=["Solid", "Dashed", "Dotted"])
lineStyleDaily     = lineStyleDailyText == "Dashed" ? line.style_dashed :
  lineStyleDailyText == "Dotted" ? line.style_dotted : line.style_solid
lineWidthDaily     = input.int(1, "Daily Line Width", minval=1, maxval=4)

// === Daily tracking ===
var float dayHigh = na
var float dayLow = na
var int   dayStartBar = na

newDay = ta.change(time("D"))
if newDay or na(dayHigh)
    dayHigh := high
    dayLow := low
    dayStartBar := bar_index
else
    dayHigh := math.max(dayHigh, high)
    dayLow := math.min(dayLow, low)

// === State for swing logic ===
var int   direction = 0         //  1 = looking for a peak, -1 = looking for a valley, 0 = uninitialised
var float extremePrice = na
var int   extremeBar = na
var float extremeDayHigh = na
var float extremeDayLow = na
var int   extremeDayStartBar = na

var line[]  dailyHighLines = array.new_line()
var line[]  dailyLowLines  = array.new_line()
var label[] pivotLabels    = array.new_label()

// Ensure the state is initialised on the very first bar.
if direction == 0
    direction := 1
    extremePrice := high
    extremeBar := bar_index
    extremeDayHigh := dayHigh
    extremeDayLow := dayLow
    extremeDayStartBar := dayStartBar

// === Helpers for cleanup ===
cleanupLines(line[] linesArray) =>
    if array.size(linesArray) > maxStoredObjects
        line lineToRemove = array.shift(linesArray)
        line.delete(lineToRemove)

cleanupLabels(label[] labelsArray) =>
    if array.size(labelsArray) > maxStoredObjects
        label labelToRemove = array.shift(labelsArray)
        label.delete(labelToRemove)

// === Pivot detection ===
bool peakConfirmed = false
bool troughConfirmed = false
int pivotBar = na
float pivotPrice = na
float pivotDayHigh = na
float pivotDayLow = na
int pivotDayStartBar = na

if direction == 1
    // Track the highest price while rising.
    if high >= extremePrice or na(extremePrice)
        extremePrice := high
        extremeBar := bar_index
        extremeDayHigh := dayHigh
        extremeDayLow := dayLow
        extremeDayStartBar := dayStartBar

    dropPercent = extremePrice != 0 ? 100.0 * (extremePrice - low) / extremePrice : na
    if dropPercent >= thresholdPercent
        peakConfirmed := true
        pivotBar := extremeBar
        pivotPrice := extremePrice
        pivotDayHigh := extremeDayHigh
        pivotDayLow := extremeDayLow
        pivotDayStartBar := extremeDayStartBar

        direction := -1
        extremePrice := low
        extremeBar := bar_index
        extremeDayHigh := dayHigh
        extremeDayLow := dayLow
        extremeDayStartBar := dayStartBar
else
    // Track the lowest price while falling.
    if low <= extremePrice or na(extremePrice)
        extremePrice := low
        extremeBar := bar_index
        extremeDayHigh := dayHigh
        extremeDayLow := dayLow
        extremeDayStartBar := dayStartBar

    risePercent = extremePrice != 0 ? 100.0 * (high - extremePrice) / math.abs(extremePrice) : na
    if risePercent >= thresholdPercent
        troughConfirmed := true
        pivotBar := extremeBar
        pivotPrice := extremePrice
        pivotDayHigh := extremeDayHigh
        pivotDayLow := extremeDayLow
        pivotDayStartBar := extremeDayStartBar

        direction := 1
        extremePrice := high
        extremeBar := bar_index
        extremeDayHigh := dayHigh
        extremeDayLow := dayLow
        extremeDayStartBar := dayStartBar

// === Visuals ===
if (peakConfirmed or troughConfirmed) and not na(pivotBar) and not na(pivotPrice)
    extendSetting = extendLinesRight ? extend.right : extend.none
    lineEndBar = extendLinesRight ? bar_index : (pivotDayStartBar + lineLengthBars)
    if not extendLinesRight and lineEndBar < bar_index
        lineEndBar := bar_index

    if not na(pivotDayHigh) and not na(pivotDayStartBar)
        line highLine = line.new(pivotDayStartBar, pivotDayHigh, lineEndBar, pivotDayHigh,
          xloc=xloc.bar_index, extend=extendSetting, color=lineColorDailyHigh,
          style=lineStyleDaily, width=lineWidthDaily)
        array.push(dailyHighLines, highLine)
        cleanupLines(dailyHighLines)

    if not na(pivotDayLow) and not na(pivotDayStartBar)
        line lowLine = line.new(pivotDayStartBar, pivotDayLow, lineEndBar, pivotDayLow,
          xloc=xloc.bar_index, extend=extendSetting, color=lineColorDailyLow,
          style=lineStyleDaily, width=lineWidthDaily)
        array.push(dailyLowLines, lowLine)
        cleanupLines(dailyLowLines)

    if showPivotLabels
        labelColor = peakConfirmed ? labelColorPeak : labelColorTrough
        labelStyle = peakConfirmed ? label.style_label_down : label.style_label_up
        labelText = peakConfirmed ? "Peak" : "Trough"
        label pivotLabel = label.new(pivotBar, pivotPrice, labelText,
          xloc=xloc.bar_index, style=labelStyle, color=labelColor, textcolor=color.white, size=size.tiny)
        array.push(pivotLabels, pivotLabel)
        cleanupLabels(pivotLabels)

plotshape(peakConfirmed ? pivotPrice : na, title="Peak Marker", style=shape.triangledown,
  location=location.absolute, color=color.new(color.red, 0), size=size.tiny, offset=0)

plotshape(troughConfirmed ? pivotPrice : na, title="Trough Marker", style=shape.triangleup,
  location=location.absolute, color=color.new(color.green, 0), size=size.tiny, offset=0)
